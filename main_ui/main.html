<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=overlays-content">
<meta name="apple-mobile-web-app-capable" content="yes"> 
<script src="base_utils.js"></script>
<script src="ColorPicker.js"></script>
<script src="pixel_draw.js"></script>
<script src="asm_gfx.js"></script>
<script src="clock.js"></script>
<script>

const PX_WIDTH = 64
const PX_HEIGHT = 32



function page_onload()
{
    //draw_pixel_onload(body, PX_WIDTH, PX_HEIGHT)
}

let ws_ref = null

function ws_connect()
{
    let url = ""
    if (window.location.protocol == "https:")
        url = "wss://"
    else
        url = "ws://"
    url += window.location.host
    if (window.location.port.length > 0)
        url += ":" + window.location.port
    url += "/ws"
    console.log("ws url: ", url)

    //url = "ws://localhost"

    const ws = new WebSocket(url) //, "cmdss")
    ws_ref = ws
    ws.addEventListener("open", (e)=>{
        //socket.send("Hello Server!")
        console.log("WS connected")
    })

    ws.addEventListener("message", (e)=>{
        console.log("WS mesg:", e.data)
    })

    ws.addEventListener("error", (e)=>{
        console.log("WS error:", e, " b ", JSON.stringify(e), " c ", ws.readyState, " d ", JSON.stringify(ws))
    })
    ws.addEventListener("close", (e)=>{
        console.log("WS close:", e, " a ", e.code, " b ", JSON.stringify(e))
    })

    const send = (cmd)=>{
        try {
            ws.send(cmd)
        }
        catch(e) {
            console.log(e)
        }
    }

    return { send:send }
}

const sections = []

function create_section(parent, text, init_vis, send_update)
{
    const cont = add_elem(parent, 'div', 'section_cont')
    const header = add_elem(cont, 'div', 'section_hdr')
    header.innerText = text
    const e = add_elem(cont, 'div', 'section_elem')
    const my_index = sections.length
    header.addEventListener('click', ()=>{
        for(let s of sections) {
            if (s.e !== e) {
                s.e.style.display = 'none'
                s.header.setAttribute('selected', false)
            }
        }
        e.style.display = 'initial'
        header.setAttribute('selected', true)
        send_update('active_section', my_index)
    })
    e.style.display = init_vis ? 'initial' : 'none'
    header.setAttribute('selected', init_vis)
    sections.push({header:header, e:e, name:text, index:my_index})
    return e
}

function create_ui(prefJson, ws)
{
    const active_section = prefJson['active_section'] || 0
    const send_update = (name, value)=>{
        const cmd = "U " + name + " " + value
        ws.send(cmd)
    }

    const clk_e = create_section(body, 'Clock', active_section == 0, send_update)
    clock_create(clk_e, prefJson, ws)
    const draw_e = create_section(body, 'Draw', active_section == 1, send_update)
    draw_pixel_create(draw_e, PX_WIDTH, PX_HEIGHT, ws)
}

function rt_start()
{
    const ws = ws_connect()

    download("/pref?t=" + new Date().getTime(), (resText)=>{
        const prefJson = JSON.parse(resText)       
        create_ui(prefJson, ws)
    })
    
}

Module.onRuntimeInitialized = rt_start

</script>
<link rel="stylesheet" type="text/css" href="pixel_draw.css">

</head>
<body id="body" onload="page_onload()"></body>

</html>